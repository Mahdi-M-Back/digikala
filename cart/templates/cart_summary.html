{% load static %}
{% load humanize %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>کوروش مال</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="{% static 'assets/favicon.ico' %}" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="{% static 'css/styles.css' %}" rel="stylesheet" />
    </head>
    <body dir="rtl">
        {% include 'navbar.html' %}
        <!-- Header-->
        <header class="bg-dark py-5">
            <div class="container px-4 px-lg-5 my-5">
                <div class="text-center text-white">
                    <h1 class="display-4 fw-bolder">سبد خرید شما</h1>
                    <p class="lead fw-normal text-white-50 mb-0">الکی</p>
                </div>
            </div>
        </header>
        <br><br>
        {% if cart_products %}
            {% for product in cart_products %}    
    <div class="container">
        <div class="card mb-3">
        <div class="row g-0">
            <div class="col-md-4">
            <img src="{{product.picture.url}}" class="img-fluid rounded-start" alt="...">
            </div>
            <div class="col-md-8">
            <div class="card-body">

                <h4 class="card-title">{{product.name}}</h4>
                <p class="card-text">{{product.description}}</p>

                {% if product.is_sale %}
                <del><p class="card-text">قیمت اصلی : {{product.price | intcomma }}</p></del><br>
                <p class="card-text">قیمت در تخفیف : {{product.sale_price | intcomma }}</p>

                {% else %}
                <p class="card-text">قیمت : {{product.price | intcomma }}</p>
                {% endif %}
                
                <br><br>
                <p class="card-text">تعداد :
                <select class="form-select" id="select{{product.id}}">
                    {% for key, value in quantities.items %}
                    {% if key == product.id|slugify %}
                    <option selected>{{value}}</option>
                    {% endif %}
                    {% endfor %}
                
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                </select>
                </p>
                <br><br>
                <button type="button"  data-index={{product.id}} class="btn btn-primary update-cart">ویرایش</button>
                <button type="button"  data-index={{product.id}} class="btn btn-danger delete-product">حذف محصول</button>
                <a href="{% url 'home' %}" class='btn btn-secondary' ">بازگشت به صفحه اصلی</a>
                <p class="card-text"><small class="text-body-secondary"></small></p>
            </div> 
            </div>
        </div>
        </div>
    </div>

    {% endfor %}

    <h1>مجموع قیمت سبدخرید : {{total | intcomma }}</h1>
    <center><a href="{% url 'checkout' %}" class="btn btn-success">صورت حساب</a></center>
    {% else %}<br><br>

    <center class="container" ><h3>your shopping cart is empty&#128531;</h3></center>
    {% endif %}
        </p>
        <br><br><br><br><br><br>
        <footer class="py-5 bg-dark">
            <div class="container"><p class="m-0 text-center text-white ">ساخته شده با &hearts; و جنگو</p>
            </div>
        </footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="{% static 'js/scripts.js' %}"></script>
    </body>
</html>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).on('click', '.update-cart', function(e){
    e.preventDefault();
    var productid = $(this).data('index');

    $.ajax({ 
        type: 'POST',
        url: "{% url 'cart_update' %}",
        data: {
            product_id : productid,
            product_qty : $('#select' + productid + ' option:selected').val(),
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post'
        },
        success: function(json) {
            alert("تعداد محصول ویرایش شد ✅");
            location.reload();  
        },
        error: function(xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
});

$(document).on('click', '.delete-product', function(e){
    e.preventDefault();
    var productid = $(this).data('index');

    $.ajax({ 
        type: 'POST',
        url: "{% url 'cart_delete' %}",
        data: {
            product_id : productid,
            csrfmiddlewaretoken: '{{ csrf_token }}',
            action: 'post'
        },
        success: function(json) {
            alert("محصول از سبد خرید حذف شد 🗑️");
            location.reload();  
        },
        error: function(xhr, errmsg, err) {
            console.log(xhr.status + ": " + xhr.responseText);
        }
    });
});
</script>
